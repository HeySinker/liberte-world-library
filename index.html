<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bibliotheca Mundi Liberi</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%230a0e14' stroke='%2300ff00' stroke-width='2'/%3E%3Cpath d='M35 45 Q35 35 50 35 Q65 35 65 45' fill='none' stroke='%2300ff00' stroke-width='3' stroke-linecap='round'/%3E%3Ccircle cx='40' cy='45' r='3' fill='%2300ff00'/%3E%3Ccircle cx='60' cy='45' r='3' fill='%2300ff00'/%3E%3Cpath d='M30 60 L70 60' stroke='%2300ff00' stroke-width='2' stroke-linecap='round'/%3E%3Cpath d='M50 25 L50 15 M40 28 L35 20 M60 28 L65 20' stroke='%2300ff00' stroke-width='2' stroke-linecap='round'/%3E%3Cpath d='M25 70 Q50 80 75 70' fill='none' stroke='%2300ff00' stroke-width='2'/%3E%3C/svg%3E">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Courier New', 'Consolas', monospace; background: #0a0e14; min-height: 100vh; padding: 20px; direction: ltr; color: #00ff00; }
        .container { max-width: 1400px; margin: 0 auto; background: #1a1f2e; border-radius: 8px; padding: 40px; box-shadow: 0 0 40px rgba(0, 255, 0, 0.1); border: 1px solid #2a3f5f; }
        
        .header { text-align: center; margin-bottom: 50px; padding-bottom: 30px; border-bottom: 2px solid #00ff00; }
        .header h1 { font-size: 2.8em; color: #00ff00; margin-bottom: 10px; font-weight: 700; text-shadow: 0 0 10px rgba(0, 255, 0, 0.5); }
        .header p { color: #7f8c8d; font-size: 1.2em; }
        .header .subtitle { color: #7f8c8d; font-size: 0.9em; margin-top: 5px; font-style: italic; }

        .stats-container {
            margin-top: 15px;
            display: inline-block;
            padding: 8px 20px;
            background: rgba(0, 255, 0, 0.05);
            border: 1px solid #00ff00;
            border-radius: 20px;
            font-weight: bold;
            color: #00ff00;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
            box-shadow: inset 0 0 10px rgba(0, 255, 0, 0.1);
        }

        .search-box { max-width: 600px; margin: 30px auto 0; position: relative; }
        .search-box input { width: 100%; padding: 15px 50px 15px 20px; border: 2px solid #2a3f5f; border-radius: 4px; font-size: 1em; background: #0d1117; color: #00ff00; font-family: 'Courier New', monospace; transition: all 0.3s; }
        .search-box input:focus { outline: none; border-color: #00ff00; box-shadow: 0 0 10px rgba(0, 255, 0, 0.3); }
        .search-icon { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: #7f8c8d; }

        .breadcrumb-container {
            margin: 20px 0 30px 0;
            padding: 15px;
            background: #0d1117;
            border: 1px solid #2a3f5f;
            border-radius: 4px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .breadcrumb {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            min-height: 45px;
        }

        .breadcrumb-item {
            background: #1a1f2e;
            color: #00ff00;
            padding: 8px 16px;
            border-radius: 4px;
            border: 1px solid #2a3f5f;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            font-weight: 600;
            font-size: 0.95em;
        }

        .breadcrumb-item:hover {
            background: #00ff00;
            color: #0a0e14;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
            border-color: #00ff00;
        }

        .breadcrumb-item.active {
            background: #00ff00;
            color: #0a0e14;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.4);
        }

        .breadcrumb-separator {
            color: #7f8c8d;
            font-weight: bold;
        }

        .category-title {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 255, 0, 0.05);
            border-left: 4px solid #00ff00;
            border-radius: 4px;
        }

        .category-title h2 {
            color: #00ff00;
            font-size: 1.5em;
            margin: 0;
        }

        .category-title p {
            color: #7f8c8d;
            margin: 5px 0 0 0;
            font-size: 0.95em;
        }
        
        .books-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .book-card { background: #0d1117; border-radius: 4px; padding: 25px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); transition: all 0.3s ease; border: 1px solid #2a3f5f; display: flex; flex-direction: column; align-items: center; text-align: center; position: relative; animation: fadeIn 0.4s ease; }
        .book-card:hover { transform: translateY(-8px); box-shadow: 0 0 20px rgba(0, 255, 0, 0.3); border-color: #00ff00; }
        
        .subfolder-badge { position: absolute; top: 10px; right: 10px; background: #0099ff; color: #0a0e14; padding: 4px 10px; border-radius: 3px; font-size: 0.75em; font-weight: 600; box-shadow: 0 0 10px rgba(0, 153, 255, 0.5); max-width: 85%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .book-icon { width: 80px; height: 80px; background: #1a1f2e; border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; color: #00ff00; border: 2px solid #2a3f5f; }
        .book-icon svg { width: 45px; height: 45px; }
        
        .book-title { font-size: 1.1em; color: #00ff00; margin-bottom: 10px; line-height: 1.4; font-weight: 600; min-height: 50px; display: flex; align-items: center; justify-content: center; word-break: break-word; }
        
        .book-meta { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; color: #7f8c8d; font-size: 0.9em; margin-bottom: 20px; }
        .book-size { background: #1a1f2e; padding: 4px 10px; border-radius: 3px; border: 1px solid #2a3f5f; }
        
        .download-btn { display: flex; align-items: center; justify-content: center; gap: 8px; background: #0d1117; color: #00ff00; padding: 12px 24px; border-radius: 4px; text-decoration: none; font-weight: 600; transition: all 0.3s; width: 100%; margin-top: auto; border: 2px solid #00ff00; cursor: pointer; }
        .download-btn:hover { background: #00ff00; color: #0a0e14; box-shadow: 0 0 20px rgba(0, 255, 0, 0.5); }
        
        .link-section {
            margin-top: 15px;
            padding: 12px;
            background: #0d1117;
            border: 1px solid #2a3f5f;
            border-radius: 4px;
            font-size: 0.85em;
            text-align: center;
            word-wrap: break-word; 
            word-break: break-all;
            overflow-wrap: break-word;
        }

        .link-section p {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }

        @media (min-width: 768px) {
            .link-section p {
                flex-direction: row; 
                justify-content: center;
            }
        }

        .copy-link {
            cursor: pointer;
            color: #00ff00;
            background: rgba(0, 255, 0, 0.05);
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px dashed #00ff00;
            display: inline-block;
            max-width: 100%;
        }

        .loading-text, .no-results { text-align: center; width: 100%; padding: 40px; color: #7f8c8d; font-size: 1.2em; grid-column: 1 / -1; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8em; }
            .container { padding: 20px 10px; }
            .books-grid { grid-template-columns: 1fr; }
            .breadcrumb-item { font-size: 0.85em; padding: 6px 12px; }
        }
    </style>
</head>
<body>

<div class="container">
    <header class="header">
        <h1>Bibliotheca Mundi Liberi</h1>
        <p>ŸÖŸÉÿ™ÿ®ÿ© ÿßŸÑÿπÿßŸÑŸÖ ÿßŸÑÿ≠ÿ±Ÿë</p>
        <p class="subtitle">The Archive of Rare & Precious Books</p>
        
        <div class="stats-container" id="statsCounter">Scanning collections...</div>
        
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search by book title or category..." autocomplete="off">
            <span class="search-icon">üîç</span>
        </div>

        <div class="link-section">
            <p>
                <span>üßÖ Backup Access:</span>
                <a href="http://7xk4m9p2qw8n5vt3bg6hj1rz0cd8efy4ua9slx2qi7nwmkopdvh3elad.onion/library" style="color: #00ff00;">Tor Mirror</a>
            </p>
        </div>

        <div class="link-section">
            <p>
                <span>Support (SOL):</span>
                <span class="copy-link" id="copySolBtn">SamJzu73QqdE2Htv7mmn9MUDALypWRoR2H51qon5R9F</span>
            </p>
        </div>

        <div class="link-section">
            <p>
                <span>Support (BTC):</span>
                <span class="copy-link" id="copyBtcBtn">1SamUEdkg5qkNPojCuvepTUMjSvp4WiUN</span>
            </p>
        </div>
    </header>

    <div class="breadcrumb-container">
        <div class="breadcrumb" id="breadcrumb"></div>
    </div>

    <div class="category-title" id="categoryTitle" style="display: none;">
        <h2 id="categoryName"></h2>
        <p id="categoryCount"></p>
    </div>

    <main>
        <div id="booksGrid" class="books-grid">
            <div class="loading-text">Loading collections from central server...</div>
        </div>
        <div id="loadMoreTrigger" style="height: 20px;"></div>
    </main>

    <footer style="text-align: center; margin-top: 50px; padding: 20px; border-top: 1px solid #2a3f5f; color: #4a5568;">
        <p>&copy; 2026 Liber Mundi - Knowledge for All | Scientia est potentia</p>
    </footer>
</div>

<script>
    const R2_BASE_URL = "https://pub-50bb0a7170f24a0fb33dc91b892ffecc.r2.dev/";
    const JSON_URL = "https://lib.psychicalbeacon.com/books_db.json";
    
    let allBooks = [];       
    let displayedBooks = []; 
    let itemsToShow = 40;
    let currentPath = [];
    let folderStructure = {};
    
    const booksGrid = document.getElementById('booksGrid');
    const searchInput = document.getElementById('searchInput');
    const statsCounter = document.getElementById('statsCounter');
    const breadcrumb = document.getElementById('breadcrumb');
    const categoryTitle = document.getElementById('categoryTitle');

    // Sort alphabetically
    function sortByAlphabet(books) {
        return books.sort((a, b) => {
            const titleA = a.t || '';
            const titleB = b.t || '';
            return titleA.localeCompare(titleB, 'en', { numeric: true });
        });
    }

    // Build hierarchical folder structure
    function buildFolderStructure(books) {
        folderStructure = {
            items: [],
            folders: {}
        };

        books.forEach(book => {
            const pathParts = book.f.split('/').filter(p => p.trim());

            if (pathParts.length === 0) {
                folderStructure.items.push(book);
                return;
            }

            let current = folderStructure;
            pathParts.forEach((part, index) => {
                if (!current.folders[part]) {
                    current.folders[part] = {
                        name: part,
                        items: [],
                        folders: {}
                    };
                }
                
                if (index === pathParts.length - 1) {
                    current.folders[part].items.push(book);
                }
                
                current = current.folders[part];
            });
        });

        sortFolderStructure(folderStructure);
    }

    function sortFolderStructure(folder) {
        folder.items = sortByAlphabet(folder.items);
        Object.values(folder.folders).forEach(subfolder => {
            sortFolderStructure(subfolder);
        });
    }

    // Calculate total book count including subfolders
    function getTotalBookCount(folder) {
        let count = folder.items.length;
        Object.values(folder.folders).forEach(subfolder => {
            count += getTotalBookCount(subfolder);
        });
        return count;
    }

    // Get subfolder count
    function getSubfolderCount(folder) {
        return Object.keys(folder.folders).length;
    }

    // Get current folder
    function getCurrentFolder() {
        let current = folderStructure;
        for (let pathPart of currentPath) {
            if (current.folders[pathPart]) {
                current = current.folders[pathPart];
            } else {
                return folderStructure;
            }
        }
        return current;
    }

    // Render current folder contents
    function renderCurrentFolder() {
        const currentFolder = getCurrentFolder();
        displayedBooks = [];

        // Add subfolders with total book count
        const folderNames = Object.keys(currentFolder.folders)
            .sort((a, b) => a.localeCompare(b, 'en', { numeric: true }));

        folderNames.forEach(folderName => {
            const folder = currentFolder.folders[folderName];
            const totalBooks = getTotalBookCount(folder);
            displayedBooks.push({
                t: folderName,
                f: 'Folder',
                s: `${totalBooks} book${totalBooks !== 1 ? 's' : ''}`,
                directBooks: folder.items.length,
                isFolder: true,
                folderName: folderName
            });
        });

        // Add books in current folder
        displayedBooks = displayedBooks.concat(sortByAlphabet([...currentFolder.items]));

        updateBreadcrumb();
        updateCategoryTitle();
        updateCounter();
        booksGrid.innerHTML = '';
        renderBooks();
    }

    // Update breadcrumb navigation
    function updateBreadcrumb() {
        breadcrumb.innerHTML = '';

        const homeBtn = document.createElement('span');
        homeBtn.className = 'breadcrumb-item' + (currentPath.length === 0 ? ' active' : '');
        homeBtn.textContent = 'üìö Home';
        homeBtn.style.cursor = 'pointer';

        homeBtn.addEventListener('click', () => {
            currentPath = [];
            window.history.pushState({ path: [] }, '', window.location.pathname);
            renderCurrentFolder();
        });

        breadcrumb.appendChild(homeBtn);

        currentPath.forEach((pathPart, index) => {
            const separator = document.createElement('span');
            separator.className = 'breadcrumb-separator';
            separator.textContent = ' / ';
            breadcrumb.appendChild(separator);

            const btn = document.createElement('span');
            btn.className = 'breadcrumb-item' + (index === currentPath.length - 1 ? ' active' : '');
            btn.textContent = pathPart;
            btn.style.cursor = 'pointer';

            btn.addEventListener('click', () => {
                currentPath = currentPath.slice(0, index + 1);
                window.history.pushState({ path: [...currentPath] }, '', `?path=${encodeURIComponent(currentPath.join('/'))}`);
                renderCurrentFolder();
            });

            breadcrumb.appendChild(btn);
        });
    }

    // Update category title
    function updateCategoryTitle() {
        if (currentPath.length === 0) {
            categoryTitle.style.display = 'none';
        } else {
            categoryTitle.style.display = 'block';
            document.getElementById('categoryName').textContent = currentPath[currentPath.length - 1];
            const currentFolder = getCurrentFolder();
            const totalBooks = getTotalBookCount(currentFolder);
            const directBooks = currentFolder.items.length;
            const subfolders = getSubfolderCount(currentFolder);
            document.getElementById('categoryCount').textContent = `${totalBooks} book${totalBooks !== 1 ? 's' : ''} (${directBooks} direct, ${subfolders} subfolder${subfolders !== 1 ? 's' : ''})`;
        }
    }

    // Render books and folders
    function renderBooks(append = false) {
        if (!append) booksGrid.innerHTML = '';

        const currentCount = append ? booksGrid.children.length : 0;
        const nextBatch = displayedBooks.slice(currentCount, currentCount + itemsToShow);

        if (nextBatch.length === 0 && !append) {
            booksGrid.innerHTML = '<div class="no-results">No items found.</div>';
            return;
        }

        const fragment = document.createDocumentFragment();
        nextBatch.forEach(item => {
            const card = document.createElement('div');
            card.className = 'book-card';

            if (item.isFolder) {
                card.innerHTML = `
                    <div class="book-icon">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V6h5.17l2 2H20v10z"/></svg>
                    </div>
                    <h3 class="book-title">${item.t}</h3>
                    <div class="book-meta"><span class="book-size">${item.s}</span></div>
                `;

                const btn = document.createElement('button');
                btn.className = 'download-btn';
                btn.textContent = 'Open Folder';

                btn.addEventListener('click', () => {
                    currentPath.push(item.folderName);
                    window.history.pushState({ path: [...currentPath] }, '', `?path=${encodeURIComponent(currentPath.join('/'))}`);
                    renderCurrentFolder();
                });

                card.appendChild(btn);
            } else {
                let path = item.p;
                if (path && path.includes('file:///')) {
                    path = path.split('/').pop();
                }

                card.innerHTML = `
                    <div class="book-icon">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 18H6a1 1 0 0 0 0 2h15v2H6a3 3 0 0 1-3-3V4a2 2 0 0 1 2-2h16v16zM5 16.05c.16-.03.33-.05.5-.05H19V4H5v12.05zM16 9H8V7h8v2zm0 4H8v-2h8v2z"/></svg>
                    </div>
                    <h3 class="book-title">${item.t}</h3>
                    <div class="book-meta"><span class="book-size">${item.s}</span></div>
                    <a class="download-btn" href="${R2_BASE_URL + (path || '')}" download target="_blank">Download Book</a>
                `;
            }
            fragment.appendChild(card);
        });
        booksGrid.appendChild(fragment);
    }

    // Initialize
    async function init() {
        try {
            const response = await fetch(JSON_URL);
            if (!response.ok) throw new Error('Failed to load');
            allBooks = await response.json();

            buildFolderStructure(allBooks);

            const params = new URLSearchParams(window.location.search);
            const pathFromUrl = params.get('path');
            if (pathFromUrl) {
                currentPath = pathFromUrl.split('/').filter(p => p.trim());
            }

            renderCurrentFolder();
            setupInfiniteScroll();
        } catch (error) {
            booksGrid.innerHTML = `<div class="no-results">‚ùå Failed to load library: ${error.message}</div>`;
        }
    }

    // Search functionality
    searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();

        if (query === "") {
            renderCurrentFolder();
            return;
        }

        displayedBooks = allBooks.filter(book =>
            book.t.toLowerCase().includes(query) ||
            book.f.toLowerCase().includes(query)
        );

        statsCounter.innerText = `Found: ${displayedBooks.length} book${displayedBooks.length !== 1 ? 's' : ''}`;
        categoryTitle.style.display = 'none';
        renderBooks(false);
    });

// Update counter
function updateCounter() {
    if (searchInput.value === "") {
        const currentFolder = getCurrentFolder();
        const directBooks = currentFolder.items.length;
        const subfolders = getSubfolderCount(currentFolder);
        const totalBooks = getTotalBookCount(currentFolder);
        
        if (currentPath.length === 0) {
            // Count ALL folders recursively, not just top-level
            function countAllFolders(folder) {
                let count = getSubfolderCount(folder);
                Object.values(folder.folders).forEach(subfolder => {
                    count += countAllFolders(subfolder);
                });
                return count;
            }
            
            const allFolders = countAllFolders(folderStructure);
            statsCounter.innerText = `Smart Book Counter: ${getTotalBookCount(folderStructure).toLocaleString()} books | ${allFolders} folders`;
        } else {
            statsCounter.innerText = `Smart Book Counter: ${totalBooks.toLocaleString()} books (${directBooks} direct | ${subfolders} subfolder${subfolders !== 1 ? 's' : ''})`;
        }
    }
}

    function setupInfiniteScroll() {
        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting && booksGrid.children.length < displayedBooks.length) {
                renderBooks(true);
            }
        }, { rootMargin: '200px' });
        observer.observe(document.getElementById('loadMoreTrigger'));
    }

    // Handle browser back button
    window.addEventListener('popstate', (event) => {
        if (event.state && event.state.path) {
            currentPath = event.state.path;
        } else {
            currentPath = [];
        }
        renderCurrentFolder();
    });

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => alert("Copied successfully!"));
    }

    document.addEventListener('DOMContentLoaded', function() {
        const copySolBtn = document.getElementById('copySolBtn');
        const copyBtcBtn = document.getElementById('copyBtcBtn');

        if (copySolBtn) {
            copySolBtn.addEventListener('click', function(e) {
                e.preventDefault();
                copyToClipboard('SamJzu73QqdE2Htv7mmn9MUDALypWRoR2H51qon5R9F');
            });
        }

        if (copyBtcBtn) {
            copyBtcBtn.addEventListener('click', function(e) {
                e.preventDefault();
                copyToClipboard('1SamUEdkg5qkNPojCuvepTUMjSvp4WiUN');
            });
        }
    });

    init();
</script>

</body>
</html>
